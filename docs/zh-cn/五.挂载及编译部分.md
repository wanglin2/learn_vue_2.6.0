[TOC]

初始化结束后，如果存在`el`属性，那么最后会进行挂载操作：

```js
if (vm.$options.el) {
    vm.$mount(vm.$options.el)
}
```

`$mount`方法是个区分平台的方法，`web`平台的如下：

```js
const mount = Vue.prototype.$mount
Vue.prototype.$mount = function (
  el,
  hydrating
) {
  el = el && query(el)
  const options = this.$options
  // 解析 template/el，编译成渲染函数
  if (!options.render) {
    // 分情况获取模板
    let template = options.template
    if (template) {
      if (typeof template === 'string') {
        if (template.charAt(0) === '#') {
          template = idToTemplate(template)
        }
      } else if (template.nodeType) {
        template = template.innerHTML
      } else {
        return this
      }
    } else if (el) {
      template = getOuterHTML(el)
    }
    if (template) {
      // 编译模板为渲染函数
      const { render, staticRenderFns } = compileToFunctions(template, {
        outputSourceRange: process.env.NODE_ENV !== 'production',
        shouldDecodeNewlines,
        shouldDecodeNewlinesForHref,
        delimiters: options.delimiters,
        comments: options.comments
      }, this)
      options.render = render
      options.staticRenderFns = staticRenderFns
    }
  }
  return mount.call(this, el, hydrating)
}
```

`Vue`的模板是需要编译成渲染函数的，所以`$mount`的主要逻辑就是判断是否存在字符串模板，存在的话才会调用编译方法，否则如果已经是渲染函数了，那么直接调用`mount`方法：

```js
Vue.prototype.$mount = function (
  el,
  hydrating
) {
  el = el && inBrowser ? query(el) : undefined
  return mountComponent(this, el, hydrating)
}
```

接下来先看一下比较简单的`mountComponent`方法。



# 挂载组件mountComponent

```js
export function mountComponent (
  vm,
  el,
  hydrating
) {
  vm.$el = el
  if (!vm.$options.render) {
    vm.$options.render = createEmptyVNode
  }
  callHook(vm, 'beforeMount')

  // 更新组件的方法
  let updateComponent = () => {
    vm._update(vm._render(), hydrating)
  }

  // 我们把Watcher实例设置为vm._watcher属性值这个逻辑放在watcher的构造函数中，因为watcher的初始补丁可能调用$forceUpdate（例如，在子组件的挂载钩子中），这需要依赖于vm._watcher先被定义
  new Watcher(vm, updateComponent, noop, {
    before () {
      if (vm._isMounted && !vm._isDestroyed) {
        callHook(vm, 'beforeUpdate')
      }
    }
  }, true /* isRenderWatcher */)
  hydrating = false

  // manually mounted instance, call mounted on self
  // mounted is called for render-created child components in its inserted hook
  if (vm.$vnode == null) {
    vm._isMounted = true
    callHook(vm, 'mounted')
  }
  return vm
}
```

`render`渲染函数其实就是一个返回虚拟`DOM`的函数，不存在的话会默认定义为一个返回空虚拟`DOM`的函数。接下来定义了一个`updateComponent`方法，这个方法是真正的挂载方法，会在初始化和更新的时候调用。接着创建了一个`Watcher`实例。



# 编译渲染函数

